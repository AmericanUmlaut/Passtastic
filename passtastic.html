<!DOCTYPE html>
<html>
  <head>    
    <meta charset="UTF-8" />
    <style type="text/css">
      #container {
        margin: 15px;
        float: left;
        padding: 15px;
        background-color: grey;
        
        -webkit-border-radius: 20px;
        border-radius: 20px;        
      }
      
      input {
        margin-top: 2px;
      }
      
      label {
        display: inline-block;
        width: 115px;
      }
      
      input.error {
        background-color: rgb(255, 175, 175);
      }
      
      .row {
        margin-bottom: 2px;
      }
      
      #output {
        position: absolute;
        left: 20px;
        top: 4px;
      }
      
      #progressBar {
        position: relative; /* Creates positioning context for the output */
        width: 200px;
        height: 30px;
        background-color: grey;
      }
      #progressBar div {
        background-color: red;
        height: 100%;
        float: left;
      }
      
      #siteNoSpecCharWarning {
        width: 500px;
        float: left;
        background-color: khaki;
        border: 1px solid brown;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div class="row">
        <label for="site">Site</label>
        <input id="site" name="site" type="text" />
      </div>
      <div class="row">
        <label for="userName">User Name</label>
        <input id="userName" name="userName" type="text" />
      </div>
      <div class="row">
        <label for="masterPw">Master Password</label>
        <input id="masterPw" name="masterPw" type="password" />
      </div>
      <div id="progressBar"><span id="output"></span><div></div></div>

      <button id="generateBtn">Generate password</button>
      <input id="noSpecChars" name="noSpecChars" type="checkbox" />
      <label for="noSpecChars">No special chars</label>
    </div>
    <div id="siteNoSpecCharWarning" style="display:none">
      <p>Well shit. It seems like <b id="noCharSiteName"></b> does not allow special characters 
      like ")" or "_" to be used in passwords. This is a stupid policy, and you ought to
      send them an e-mail and ask them to change their foolish ways, but until they do, we
      suggest that you click the "No special chars" box.</p>
      <p>Remember! If you use the "No special chars" option to create a password, you have to make sure
      to select it whenever you generate your password for that site!</p> 
    </div>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="MochiKit/MochiKit.js" type="text/javascript"></script>
    <script src="Clipperz/Base.js" type="text/javascript"></script>
    <script src="Clipperz/ByteArray.js" type="text/javascript"></script>
    <script src="Clipperz/Crypto/BigInt.js" type="text/javascript"></script>
    <script src="Clipperz/Crypto/SHA.js" type="text/javascript"></script>
    <script src="Clipperz/Crypto/AES.js" type="text/javascript"></script>
    <script src="Clipperz/Crypto/PRNG.js" type="text/javascript"></script>
    <script src="bCrypt.js" type="text/javascript"></script>  
    <script src="md5.js" type="text/javascript"></script>  
    <script src="passtastic.js" type="text/javascript"></script>  
    <script type="text/javascript">
      (function($) {
        //Domains that do not permit special characters in their passwords - the option to generate a password withou
        // special characters will be recommended to the user for these sites.
        var NO_SPEC_CHAR_SITES = [
          'stayfriends.de', //They do allow special characters via user settings, but not on their new-user landing page due to a bug.
          'delta.com',
          'hapo.org' //does not allow | ^ ' " ( ) [ ] { } < >
        ];
  
        var progressCount;
        
        function generateHash() {
          resetProgressBar();
          
          Passtastic.getPassword($('#site').val(), 
                                 $('#userName').val(), 
                                 $('#masterPw').val(),
                                 !$('#noSpecChars').is(':checked'),
                                 function(result) {
                                   // We have to count how many progress steps have actually been taken, because
                                   //bcrypt's progress callback is called an unpredictable number of times.
                                   while(progressCount < 100) {
                                     updateProgressBar();
                                   }
                                   $('#output').text(result) 
                                 },
                                 function() {
                                   updateProgressBar();
                                 });
        }
        function resetProgressBar() {
          progressCount = 1;
          $('#progressBar div').css('width', 0);
        }
        function updateProgressBar() {
          ++progressCount;
          $('#progressBar div').css('width', progressCount+'%');
        }
        $('#generateBtn').click(function() {          
          generateHash();
        });
        
        $('#site').keyup(function() {
          var site = $(this).val(),
              warning = $('#siteNoSpecCharWarning');

          if(NO_SPEC_CHAR_SITES.indexOf(site) != -1) {
            $('#noCharSiteName').text(site);
            warning.show();
          } 
          else {
            warning.hide();
          }  
        });
        
        $('#site').keyup(); //Trigger once in case the user has already typed while scripts loaded
        
        $(document).keypress(function(event) {
          if(event.which == 13) {
            generateHash();
          }
        });
        
        $(document).ready(function() {
          $('#site').focus();
        });
      })(jQuery);
    </script>
  </body>
</html>